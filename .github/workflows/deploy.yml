# ============================================
# FACTORY V2 - Auto Deploy on Main
# ============================================
# D√©ploiement automatique vers VPS Infomaniak
#
# Trigger:
#   - Push sur branche 'main' (automatique)
#   - Manuel via workflow_dispatch
#
# Stack d√©tect√©e:
#   - Next.js 14 (standalone output)
#   - Docker multi-stage build
#   - Traefik reverse proxy
#
# Secrets requis dans GitHub:
#   - VPS_HOST: IP du serveur (83.228.218.6)
#   - VPS_USER: Utilisateur SSH (mickadmin)
#   - SSH_PRIVATE_KEY: Cl√© priv√©e SSH (ed25519 ou rsa)

name: üöÄ Deploy to Production

on:
  # ============================================
  # TRIGGER AUTOMATIQUE sur push vers main
  # ============================================
  push:
    branches:
      - main
    # Ignorer les commits qui ne changent que la doc
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'

  # ============================================
  # TRIGGER MANUEL (backup)
  # ============================================
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip Docker rebuild (just restart)'
        type: boolean
        default: false

env:
  # Chemin du projet sur le VPS
  PROJECT_PATH: /home/mickadmin/docker/website
  # Nom de l'image Docker
  DOCKER_IMAGE: factory-v2:latest

jobs:
  deploy:
    name: üîÑ Deploy to VPS
    runs-on: ubuntu-latest
    
    # Timeout de s√©curit√© (√©vite les jobs bloqu√©s)
    timeout-minutes: 15
    
    # √âviter les d√©ploiements simultan√©s
    concurrency:
      group: production-deploy
      cancel-in-progress: false

    steps:
      # ============================================
      # STEP 1: Afficher les infos de d√©ploiement
      # ============================================
      - name: üìã Display deployment info
        run: |
          echo "üöÄ D√©ploiement d√©clench√© par: ${{ github.actor }}"
          echo "üåø Branche: ${{ github.ref_name }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo "üí¨ Message: ${{ github.event.head_commit.message || 'Manual trigger' }}"
          echo "üìÖ Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      # ============================================
      # STEP 2: D√©ploiement via SSH
      # ============================================
      - name: üîê Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          # Timeout de connexion SSH (secondes)
          timeout: 60s
          # Timeout du script (secondes)
          command_timeout: 10m
          script: |
            set -e  # Arr√™ter en cas d'erreur
            
            echo "============================================"
            echo "üöÄ DEPLOY FACTORY V2 - NEXT.JS"
            echo "============================================"
            echo "üìÖ Date: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "üìÅ Dossier: ${{ env.PROJECT_PATH }}"
            echo ""
            
            # --- Aller dans le dossier du projet ---
            cd ${{ env.PROJECT_PATH }}
            
            # --- V√©rification du dossier Git ---
            if [ ! -d ".git" ]; then
              echo "‚ùå ERREUR: Ce n'est pas un d√©p√¥t Git!"
              exit 1
            fi
            
            # --- Pull des modifications ---
            echo "üì• Pull des derni√®res modifications..."
            git fetch --all
            git reset --hard origin/main
            
            echo ""
            echo "üì¶ Dernier commit r√©cup√©r√©:"
            git log -1 --pretty=format:"  %h - %s (%cr) <%an>"
            echo ""
            
            # --- Build de l'image Docker ---
            SKIP_BUILD="${{ inputs.skip_build || 'false' }}"
            if [ "$SKIP_BUILD" != "true" ]; then
              echo ""
              echo "üê≥ Reconstruction de l'image Docker..."
              docker build -t ${{ env.DOCKER_IMAGE }} .
            else
              echo ""
              echo "‚è≠Ô∏è Skip du build Docker (option activ√©e)"
            fi
            
            # --- Red√©marrage du conteneur ---
            echo ""
            echo "‚ôªÔ∏è Red√©marrage du conteneur..."
            docker compose down
            docker compose up -d
            
            # --- Nettoyage des anciennes images ---
            echo ""
            echo "üßπ Nettoyage des images orphelines..."
            docker image prune -f
            
            # --- V√©rification du statut ---
            echo ""
            echo "‚úÖ V√©rification du conteneur..."
            sleep 5
            docker compose ps
            
            # --- Health check ---
            echo ""
            echo "üè• Health check..."
            sleep 3
            if curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "‚úÖ L'application r√©pond correctement!"
            else
              echo "‚ö†Ô∏è Health check √©chou√© - v√©rifier les logs avec: docker compose logs"
            fi
            
            echo ""
            echo "============================================"
            echo "‚úÖ DEPLOY TERMIN√â AVEC SUCC√àS"
            echo "============================================"

      # ============================================
      # STEP 3: Notification de succ√®s
      # ============================================
      - name: ‚úÖ Deployment successful
        if: success()
        run: |
          echo "üéâ D√©ploiement r√©ussi!"
          echo "üîó Commit: ${{ github.sha }}"
          echo "üåê Site: https://mick-solutions.ch"

      # ============================================
      # STEP 4: Notification d'√©chec
      # ============================================
      - name: ‚ùå Deployment failed
        if: failure()
        run: |
          echo "‚ùå Le d√©ploiement a √©chou√©!"
          echo "üìã V√©rifiez les logs ci-dessus pour plus de d√©tails."
          echo ""
          echo "üîß Debug tips:"
          echo "  1. V√©rifier que la cl√© SSH est correcte (SSH_PRIVATE_KEY)"
          echo "  2. V√©rifier que VPS_HOST = 83.228.218.6"
          echo "  3. V√©rifier que VPS_USER = mickadmin"
          echo "  4. S'assurer que le d√©p√¥t Git existe sur le VPS"
