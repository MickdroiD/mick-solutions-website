# ============================================
# FACTORY V2 - Auto Deploy on Main
# ============================================
# DÃ©ploiement automatique vers VPS Infomaniak
#
# Trigger:
#   - Push sur branche 'main' (automatique)
#   - Manuel via workflow_dispatch
#
# Secrets requis dans GitHub:
#   - VPS_HOST: IP du serveur (83.228.218.6)
#   - VPS_USER: Utilisateur SSH (mickadmin)
#   - SSH_PRIVATE_KEY_BASE64: ClÃ© privÃ©e SSH encodÃ©e en base64

name: ğŸš€ Deploy to Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'

  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip Docker rebuild (just restart)'
        type: boolean
        default: false

env:
  PROJECT_PATH: /home/mickadmin/docker/website
  DOCKER_IMAGE: factory-v2:latest

jobs:
  deploy:
    name: ğŸ”„ Deploy to VPS
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    concurrency:
      group: production-deploy
      cancel-in-progress: false

    steps:
      - name: ğŸ“‹ Display deployment info
        run: |
          echo "ğŸš€ DÃ©ploiement dÃ©clenchÃ© par: ${{ github.actor }}"
          echo "ğŸŒ¿ Branche: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ“… Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: ğŸ”‘ Setup SSH Key
        env:
          SSH_KEY_BASE64: ${{ secrets.SSH_PRIVATE_KEY_BASE64 }}
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_KEY_BASE64}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: ğŸ” Deploy via SSH
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
          set -e
          
          echo "============================================"
          echo "ğŸš€ DEPLOY FACTORY V2 - NEXT.JS"
          echo "============================================"
          echo "ğŸ“… Date: $(date '+%Y-%m-%d %H:%M:%S')"
          
          cd /home/mickadmin/docker/website
          
          if [ ! -d ".git" ]; then
            echo "âŒ ERREUR: Ce n'est pas un dÃ©pÃ´t Git!"
            exit 1
          fi
          
          echo "ğŸ“¥ Pull des derniÃ¨res modifications..."
          git fetch --all
          git reset --hard origin/main
          
          echo ""
          echo "ğŸ“¦ Dernier commit rÃ©cupÃ©rÃ©:"
          git log -1 --pretty=format:"  %h - %s (%cr) <%an>"
          echo ""
          
          echo ""
          echo "ğŸ³ Reconstruction de l'image Docker..."
          docker build -t factory-v2:latest .
          
          echo ""
          echo "â™»ï¸ RedÃ©marrage du conteneur..."
          docker compose down
          docker compose up -d
          
          echo ""
          echo "ğŸ§¹ Nettoyage des images orphelines..."
          docker image prune -f
          
          echo ""
          echo "âœ… VÃ©rification du conteneur..."
          sleep 5
          docker compose ps
          
          echo ""
          echo "============================================"
          echo "âœ… DEPLOY TERMINÃ‰ AVEC SUCCÃˆS"
          echo "============================================"
          ENDSSH

      - name: âœ… Deployment successful
        if: success()
        run: |
          echo "ğŸ‰ DÃ©ploiement rÃ©ussi!"
          echo "ğŸŒ Site: https://mick-solutions.ch"

      - name: âŒ Deployment failed
        if: failure()
        run: |
          echo "âŒ Le dÃ©ploiement a Ã©chouÃ©!"
          echo "ğŸ”§ VÃ©rifiez les secrets GitHub: SSH_PRIVATE_KEY_BASE64, VPS_HOST, VPS_USER"
