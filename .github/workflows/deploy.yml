# Deploy to VPS - Simplified
name: ğŸš€ Deploy to Production

on:
  push:
    branches: [main]
    paths-ignore: ['**.md', 'docs/**']
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“‹ Info
        run: |
          echo "Commit: ${{ github.sha }}"
          echo "Checking secrets..."
          
      - name: ğŸ”‘ Debug secrets
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then echo "âŒ VPS_HOST missing"; else echo "âœ… VPS_HOST OK"; fi
          if [ -z "${{ secrets.VPS_USER }}" ]; then echo "âŒ VPS_USER missing"; else echo "âœ… VPS_USER OK"; fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY_BASE64 }}" ]; then echo "âŒ SSH_PRIVATE_KEY_BASE64 missing"; else echo "âœ… SSH_PRIVATE_KEY_BASE64 OK (length: ${#SSH_KEY})"; fi
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY_BASE64 }}

      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_BASE64 }}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "SSH key created, checking..."
          ls -la ~/.ssh/deploy_key
          head -1 ~/.ssh/deploy_key

      - name: ğŸ” Test SSH Connection
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'âœ… SSH Connection OK!'"

      - name: ğŸš€ Deploy
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "cd /home/mickadmin/docker/website && git fetch --all && git reset --hard origin/main && docker build -t factory-v2:latest . && docker compose down && docker compose up -d && docker image prune -f && echo 'âœ… Deploy done!'"
