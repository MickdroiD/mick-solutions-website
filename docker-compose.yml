# ============================================
# FACTORY V2 - Production Docker Compose
# ============================================

services:
  website-client:
    image: factory-${CONTAINER_NAME:-client}:latest
    build:
      context: .
      # ### CORRECTION ICI : Ajout des variables manquantes pour le BUILD ###
      args:
        - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL}
        - BASEROW_API_URL=${BASEROW_API_URL:-https://baserow.mick-solutions.ch/api}
        - BASEROW_API_TOKEN=${BASEROW_API_TOKEN}
        - BASEROW_FACTORY_GLOBAL_ID=${BASEROW_FACTORY_GLOBAL_ID}
        - BASEROW_FACTORY_SECTIONS_ID=${BASEROW_FACTORY_SECTIONS_ID}
    
    # --- CORRECTION D'ALIGNEMENT ICI ---
    # "volumes" doit être au même niveau que "build" (pas dedans)
    volumes:
      - /home/mickadmin/docker/website/public/uploads:/app/public/uploads
      
    container_name: ${CONTAINER_NAME:-factory-client}
    restart: unless-stopped

    # ============================================
    # ENVIRONMENT VARIABLES (Pour le démarrage)
    # ============================================
    environment:
      # === REQUIRED ===
      - NODE_ENV=production
      - BASEROW_API_TOKEN=${BASEROW_API_TOKEN}
      - BASEROW_FACTORY_GLOBAL_ID=${BASEROW_FACTORY_GLOBAL_ID}
      - BASEROW_FACTORY_SECTIONS_ID=${BASEROW_FACTORY_SECTIONS_ID}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}

      # === OPTIONAL ===
      - SITE_NAME=${SITE_NAME:-Factory V2}
      - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL}
      - BASEROW_API_URL=${BASEROW_API_URL:-https://baserow.mick-solutions.ch/api}

      # === JWT ===
      - JWT_SECRET=${JWT_SECRET:-}

      # === AI FEATURES ===
      - DEFAULT_AI_API_KEY=${DEFAULT_AI_API_KEY:-}

    # ============================================
    # NETWORKS
    # ============================================
    networks:
      - proxy

    # ============================================
    # TRAEFIK LABELS
    # ============================================
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.factory-client.rule=Host(`${DOMAIN}`) || Host(`www.${DOMAIN}`)"
      - "traefik.http.routers.factory-client.entrypoints=websecure"
      - "traefik.http.routers.factory-client.tls.certresolver=myresolver"
      - "traefik.http.services.factory-client.loadbalancer.server.port=3000"

# ============================================
# NETWORKS
# ============================================
networks:
  proxy:
    external: true
